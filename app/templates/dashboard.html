<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMRS Databank</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #fff; --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #64748b; --text-muted: #94a3b8;
            --border-color: #e2e8f0; --accent-primary: #3b82f6; --accent-secondary: #1d4ed8;
            --success: #10b981; --error: #ef4444; --shadow: rgba(0,0,0,.1); --shadow-dark: rgba(0,0,0,.2);
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
            --text-primary: #f8fafc; --text-secondary: #cbd5e1; --border-color: #475569;
            --accent-primary: #60a5fa; --shadow: rgba(0,0,0,.5); --shadow-dark: rgba(0,0,0,.8);
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: all .3s; }
        
        /* Header */
        .main-header { background: var(--bg-secondary); border-bottom: 2px solid var(--border-color); padding: 0; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 4px 20px var(--shadow); }
        .header-container { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 80px; }
        .header-logo { display: flex; align-items: center; gap: 15px; text-decoration: none; color: var(--text-primary); }
        .header-logo .logo-icon { width: 115px; height: 115px; border-radius: 12px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .header-logo .logo-icon img { width: 100%; height: 100%; object-fit: contain; }
        .header-logo .logo-text h1 { font-size: 1.8rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-logo .logo-text span { font-size: .85rem; color: var(--text-muted); font-weight: 500; }
        
        .header-search { flex: 1; max-width: 500px; margin: 0 40px; }
        .search-container { position: relative; display: flex; align-items: center; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 25px; padding: 0 20px; transition: all .3s; }
        .search-container:focus-within { border-color: var(--accent-primary); box-shadow: 0 0 0 4px rgba(59,130,246,.1); transform: translateY(-1px); }
        .search-container i { color: var(--text-muted); margin-right: 12px; }
        .search-container input { flex: 1; border: none; background: transparent; color: var(--text-primary); font-size: 1rem; padding: 15px 0; outline: none; }
        .search-container input::placeholder { color: var(--text-muted); }
        
        .header-controls { display: flex; align-items: center; gap: 20px; }
        .language-selector { position: relative; }
        .lang-current { display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all .3s; font-weight: 500; color: var(--text-primary); }
        .lang-current:hover { border-color: var(--accent-primary); transform: translateY(-1px); }
        .flag-icon { width: 20px; height: 15px; border-radius: 3px; }
        .lang-dropdown { position: absolute; top: 100%; right: 0; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 10px; box-shadow: 0 8px 25px var(--shadow-dark); min-width: 150px; opacity: 0; transform: translateY(-10px); transition: all .3s; pointer-events: none; z-index: 1000; margin-top: 5px; }
        .lang-dropdown.show { opacity: 1; transform: translateY(0); pointer-events: all; }
        .lang-option { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; transition: all .2s; color: var(--text-primary); }
        .lang-option:hover { background: var(--bg-tertiary); }
        
        .theme-toggle { position: relative; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 25px; padding: 4px; }
        .toggle-switch { position: relative; width: 64px; height: 32px; background: var(--bg-tertiary); border-radius: 25px; cursor: pointer; transition: all .3s; }
        .toggle-switch::before { content: ''; position: absolute; width: 24px; height: 24px; background: var(--accent-primary); border-radius: 50%; top: 4px; left: 4px; transition: all .3s; box-shadow: 0 2px 4px var(--shadow); }
        .toggle-switch.active::before { transform: translateX(32px); background: var(--accent-secondary); }
        .toggle-icons { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; pointer-events: none; }
        .toggle-icons i { font-size: 12px; color: var(--text-muted); transition: all .3s; }
        
        .social-links { display: flex; gap: 8px; }
        .social-link { width: 40px; height: 40px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; transition: all .3s; font-size: 1.1rem; }
        .social-link:hover { transform: translateY(-2px); color: white; border-color: transparent; }
        .social-link[href*="telegram"]:hover { background: #0088cc; }
        .social-link[href*="instagram"]:hover { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .social-link[href*="facebook"]:hover { background: #1877f2; }
        .social-link[href*="youtube"]:hover { background: #ff0000; }
        
        /* Container */
        .container { display: flex; min-height: 100vh; margin-top: 80px; }
        
        /* Sidebar */
        .sidebar { width: 560px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; overflow-y: auto; position: fixed; height: calc(100vh - 80px); top: 80px; left: 0; z-index: 100; transition: all .3s; box-shadow: 4px 0 20px var(--shadow); }
        .sidebar h2 { color: var(--text-primary); margin-bottom: 25px; text-align: center; border-bottom: 3px solid var(--accent-primary); padding-bottom: 15px; font-weight: 700; font-size: 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Filter Section */
        .filter-section { margin-bottom: 25px; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; background: var(--bg-secondary); box-shadow: 0 2px 8px var(--shadow); transition: all .3s; }
        .filter-section:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--shadow-dark); }
        .section-header { background: var(--bg-tertiary); padding: 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--text-primary); transition: all .3s; }
        .section-header:hover { background: var(--border-color); }
        .section-title { display: flex; align-items: center; gap: 12px; font-size: 1.1rem; }
        .section-title i { color: var(--accent-primary); font-size: 1.2rem; }
        .section-stats { font-size: .85rem; color: var(--text-muted); font-weight: 500; }
        .selected-count { color: var(--accent-primary); font-weight: 700; }
        .section-content { max-height: 480px; overflow: hidden; transition: max-height .4s; }
        .section-content.collapsed { max-height: 0; }
        
        /* Controls */
        .filter-controls { padding: 18px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); }
        .controls-row { display: flex; gap: 10px; align-items: center; }
        .search-input { flex: 1; padding: 12px 8px; border: 2px solid var(--border-color); border-radius: 10px; font-size: .95rem; background: var(--bg-secondary); color: var(--text-primary); transition: all .3s; }
        .search-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 4px rgba(59,130,246,.1); transform: translateY(-1px); }
        .control-btn { padding: 12px; border: 2px solid var(--border-color); background: var(--bg-secondary); border-radius: 10px; cursor: pointer; color: var(--text-secondary); transition: all .3s; min-width: 45px; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { background: var(--accent-primary); color: white; border-color: var(--accent-primary); transform: translateY(-2px); }
        
        /* Alphabet Filter */
        .alphabet-filter { display: flex; flex-wrap: wrap; gap: 4px; padding: 15px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); justify-content: center; }
        .alphabet-btn { width: 28px; height: 28px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-secondary); border-radius: 6px; cursor: pointer; font-size: .8rem; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: all .2s; }
        .alphabet-btn:hover, .alphabet-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); transform: translateY(-1px); }
        .alphabet-btn.disabled { opacity: .3; cursor: not-allowed; pointer-events: none; }
        
        /* Items List */
        .items-list { max-height: 300px; overflow-y: auto; padding: 10px 0; }
        .filter-item { display: flex; align-items: center; padding: 8px 15px; transition: all .2s; border-radius: 6px; margin: 0 8px 4px 8px; min-height: 40px; }
        .filter-item:hover { background: var(--bg-tertiary); transform: translateX(4px); }
        .filter-item-icon { width: 20px; height: 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: .7rem; color: white; font-weight: bold; }
        .filter-item input[type="checkbox"] { margin-right: 10px; width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent-primary); }
        .filter-item label { cursor: pointer; font-size: .9rem; color: var(--text-primary); flex: 1; font-weight: 500; line-height: 1.3; }
        .filter-item .count { font-size: .8rem; color: var(--text-muted); margin-left: 8px; background: var(--bg-tertiary); padding: 3px 6px; border-radius: 4px; font-weight: 600; }
        
        /* Grid Layouts */
        .countries-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; padding: 5px; }
        .countries-grid .filter-item { margin: 0; padding: 6px 10px; font-size: .85rem; }
        .years-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; padding: 15px; }
        .year-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 8px; transition: all .2s; background: var(--bg-secondary); min-height: 40px; position: relative; }
        .year-item:hover { background: var(--bg-tertiary); transform: translateY(-1px); }
        .year-item::before { content: '!'; position: absolute; left: 8px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: .8rem; border-radius: 50%; background: linear-gradient(135deg, #559bf9, #559bf9); color: white; }
        .year-item input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent-primary); margin-left: 25px; }
        .year-item label { cursor: pointer; font-size: .9rem; font-weight: 600; color: var(--text-primary); flex: 1; }
        
        .trade-direction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; }
        .trade-direction-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; border-radius: 8px; transition: all .2s; background: var(--bg-secondary); border: 2px solid var(--border-color); min-height: 50px; position: relative; }
        .trade-direction-item:hover { background: var(--bg-tertiary); transform: translateY(-1px); border-color: var(--accent-primary); }
        .trade-direction-item input { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-primary); margin-left: 35px; }
        .trade-direction-item label { cursor: pointer; font-size: .95rem; font-weight: 600; color: var(--text-primary); flex: 1; }
        .trade-direction-item::before { content: ''; position: absolute; left: 12px; width: 24px; height: 24px; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .trade-direction-item[data-type="export"]::before { content: '↗'; background: linear-gradient(135deg, #10b981, #059669); }
        .trade-direction-item[data-type="import"]::before { content: '↙'; background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        /* Main Content */
        .main-content { flex: 1; padding: 30px; margin-left: 540px; }
        
        /* Preview Panel */
        .preview-panel { background: var(--bg-secondary); border-radius: 16px; padding: 50px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 24px var(--shadow); transition: all .3s; }
        .preview-icon { font-size: 5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 25px; }
        .preview-panel h2 { color: var(--text-primary); margin-bottom: 20px; font-size: 2rem; font-weight: 700; }
        .preview-panel p { color: var(--text-secondary); margin-bottom: 35px; font-size: 1.15rem; line-height: 1.6; }
        .requirements { margin: 35px 0; display: flex; flex-direction: column; gap: 16px; }
        .requirement { display: flex; align-items: center; justify-content: center; font-size: 1.1rem; padding: 16px; border-radius: 12px; background: var(--bg-tertiary); border: 2px solid var(--border-color); transition: all .3s; font-weight: 500; }
        .requirement.completed { background: rgba(16,185,129,.1); border-color: var(--success); color: var(--success); transform: scale(1.02); }
        .requirement i { margin-right: 12px; width: 24px; font-size: 1.2rem; }
        .apply-btn { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; padding: 18px 35px; border-radius: 12px; cursor: pointer; font-size: 1.15rem; font-weight: 600; transition: all .3s; display: inline-flex; align-items: center; gap: 10px; min-width: 220px; justify-content: center; box-shadow: 0 4px 16px rgba(59,130,246,.3); }
        .apply-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(59,130,246,.4); }
        .apply-btn:disabled { background: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Results Panel */
        .results-panel { display: none; background: var(--bg-secondary); border-radius: 16px; padding: 25px; border: 1px solid var(--border-color); box-shadow: 0 4px 24px var(--shadow); }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .results-header h3 { color: var(--text-primary); display: flex; align-items: center; gap: 12px; font-size: 1.4rem; font-weight: 700; }
        .results-count { color: var(--accent-primary); font-weight: 600; font-size: .95rem; }
        .header-buttons { display: flex; gap: 12px; }
        
        /* Selection Summary */
        .current-selection-summary { background: linear-gradient(135deg, var(--bg-tertiary), var(--border-light)); border: 2px solid var(--border-color); border-radius: 16px; padding: 25px; margin-bottom: 25px; }
        .selection-tags { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .selection-tag-group { background: var(--bg-secondary); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px var(--shadow); }
        .selection-tag-group strong { display: block; margin-bottom: 10px; color: var(--text-primary); font-size: .95rem; font-weight: 600; }
        .selection-tag-group span { color: var(--accent-primary); font-weight: 600; font-size: 1rem; line-height: 1.5; }
        .new-search-section { text-align: center; padding-top: 25px; border-top: 2px solid var(--border-color); }
        .new-search-hint { margin: 12px 0 0 0; font-size: .95rem; color: var(--text-muted); font-style: italic; }
        
        /* Chart Controls */
        .chart-controls { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 20px; padding: 20px; box-shadow: 0 4px 16px var(--shadow); }
        .controls-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .controls-header h4 { color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: 600; }
        .view-toggles { display: flex; gap: 8px; background: var(--bg-tertiary); padding: 4px; border-radius: 10px; border: 1px solid var(--border-color); }
        .view-btn { padding: 10px 16px; border: none; background: transparent; color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: all .3s; font-weight: 500; display: flex; align-items: center; gap: 8px; font-size: .9rem; }
        .view-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .view-btn.active { background: var(--accent-primary); color: white; }
        
        /* Country Selector */
        .country-selector-section { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 15px; padding: 20px; box-shadow: 0 2px 8px var(--shadow); }
        .selector-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .selector-header h4 { color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; font-weight: 600; }
        .selector-controls { display: flex; gap: 10px; align-items: center; }
        .country-select { padding: 8px 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: .9rem; cursor: pointer; min-width: 180px; font-weight: 500; }
        .country-select:focus { outline: none; border-color: var(--accent-primary); }
        .selected-country-info { margin-top: 15px; animation: slideDown .3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .country-card { background: linear-gradient(135deg, var(--bg-tertiary), var(--border-light)); border: 1px solid var(--border-color); border-radius: 12px; padding: 18px; display: flex; align-items: center; gap: 15px; }
        .country-flag { width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4rem; }
        .country-details { flex: 1; }
        .country-details h5 { margin: 0 0 8px 0; color: var(--text-primary); font-size: 1.2rem; font-weight: 700; }
        .country-details p { margin: 0; color: var(--text-secondary); font-size: .9rem; }
        .country-metrics { display: flex; flex-direction: column; gap: 8px; }
        .metric { display: flex; flex-direction: column; align-items: flex-end; }
        .metric-label { font-size: .8rem; color: var(--text-muted); font-weight: 500; }
        .metric-value { font-size: 1rem; color: var(--accent-primary); font-weight: 700; }
        
        /* Chart Container */
        .chart-container { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 20px; padding: 25px; box-shadow: 0 4px 16px var(--shadow); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .chart-header h4 { color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: 600; }
        .chart-controls-row { display: flex; gap: 12px; align-items: center; }
        .chart-select { padding: 10px 14px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: .9rem; cursor: pointer; min-width: 140px; }
        .chart-content { position: relative; height: 540px; background: var(--bg-tertiary); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color); }
        .chart-content canvas { max-width: 100%; max-height: 100%; }
        
        /* Metadata Container */
        .metadata-container { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 20px; padding: 25px; box-shadow: 0 4px 16px var(--shadow); }
        .metadata-header h4 { color: var(--text-primary); margin: 0 0 25px 0; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: 600; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .metadata-section-selector { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; }
        .section-info p { margin: 0; color: var(--text-secondary); font-size: .9rem; display: flex; align-items: center; gap: 8px; }
        .section-info i { color: var(--accent-primary); }
        .metadata-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .metadata-card { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px; transition: all .3s; }
        .metadata-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
        .metadata-info h5 { margin: 0 0 5px 0; color: var(--text-primary); font-size: .95rem; font-weight: 600; }
        .metadata-info p { margin: 0; color: var(--accent-primary); font-size: 1.1rem; font-weight: 700; }
        .detailed-stats { background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-top: 20px; }
        .detailed-stats h5 { color: var(--text-primary); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; font-weight: 600; }
        .stats-table { max-height: 300px; overflow-y: auto; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); transition: all .2s; }
        .stats-row:hover { background: var(--bg-secondary); border-radius: 6px; padding-left: 10px; padding-right: 10px; }
        .stats-country { font-weight: 600; color: var(--text-primary); }
        .stats-value { color: var(--accent-primary); font-weight: 600; font-size: .95rem; }
        
        /* Results Table */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 16px var(--shadow); background: var(--bg-secondary); }
        .results-table th { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; padding: 15px 8px; text-align: left; font-weight: 600; font-size: .85rem; }
        .results-table td { padding: 12px 8px; border-bottom: 1px solid var(--border-color); font-size: .85rem; color: var(--text-primary); }
        .results-table tr:hover { background: var(--bg-tertiary); }
        .year-badge { background: var(--accent-primary); color: white; padding: 6px 10px; border-radius: 8px; font-size: .8rem; font-weight: 600; }
        
        /* Loading & States */
        .loading, .no-data { text-align: center; padding: 40px; color: var(--text-muted); grid-column: 1 / -1; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top: 3px solid var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: var(--text-muted); }
        
        /* Toast */
        .toast { position: fixed; top: 80px; right: 20px; background: var(--success); color: white; padding: 18px 24px; border-radius: 12px; box-shadow: 0 8px 24px var(--shadow-dark); transform: translateX(100%); transition: all .4s; z-index: 1000; max-width: 400px; font-weight: 500; }
        .toast.show { transform: translateX(0); }
        .toast.error { background: var(--error); }
        .toast.info { background: var(--accent-primary); }
        
        /* Footer */
        .simple-footer { background: var(--bg-secondary); border-top: 2px solid var(--border-color); margin-top: 50px; margin-left: 540px; padding: 30px 0; position: relative; }
        .simple-footer::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-primary)); }
        .simple-footer .footer-content { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
        .simple-footer .footer-logo { display: flex; align-items: center; gap: 12px; }
        .simple-footer .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; margin-left: 25px; }
        .simple-footer .logo-text span { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .simple-footer .footer-info { text-align: right; color: var(--text-secondary); }
        .simple-footer .footer-info p { margin: 0; font-size: .9rem; line-height: 1.4; }
        .simple-footer .copyright { margin-top: 8px; font-size: .8rem; color: var(--text-muted); font-style: italic; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { position: static; width: 100%; height: auto; box-shadow: none; }
            .container { margin-top: 70px; flex-direction: column; }
            .main-content { margin-left: 0; padding: 20px; }
            .simple-footer { margin-left: 0; }
            .header-container { height: 70px; padding: 0 15px; }
            .header-search { display: none; }
            .countries-grid { grid-template-columns: 1fr; }
            .years-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
            .trade-direction-grid { grid-template-columns: 1fr; }
            .selection-tags { grid-template-columns: 1fr; }
            .metadata-grid { grid-template-columns: 1fr; }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 4px; }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-container">
            <div class="header-logo">
                <div class="logo-icon">
                    <a href="/"><img src="static/images/screen.png" alt="IFMR Logo"></a>
                </div>
                <div class="logo-text"></div>
            </div>
            <div class="header-search">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Ma'lumotlarni qidirish..." id="headerSearch">
                </div>
            </div>
            <div class="header-controls">
                <div class="language-selector">
                    <div class="lang-current" onclick="toggleLanguageDropdown()">
                        <img src="https://flagcdn.com/w20/uz.png" alt="UZ" />
                        <span>UZ</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="lang-dropdown" id="langDropdown">
                        <div class="lang-option" onclick="changeLanguage('uz')">
                            <img src="https://flagcdn.com/w20/uz.png" alt="UZ" />
                            <span>O'zbekcha</span>
                        </div>
                        <div class="lang-option" onclick="changeLanguage('ru')">
                            <img src="https://flagcdn.com/w20/ru.png" alt="RU" />
                            <span>Русский</span>
                        </div>
                        <div class="lang-option" onclick="changeLanguage('en')">
                            <img src="https://flagcdn.com/w20/gb.png" alt="EN" />
                            <span>English</span>
                        </div>
                    </div>
                </div>
                <div class="theme-toggle">
                    <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()">
                        <div class="toggle-icons">
                            <i class="fas fa-sun"></i>
                            <i class="fas fa-moon"></i>
                        </div>
                    </div>
                </div>
                <div class="social-links">
                    <a href="https://t.me/imri_uz" target="_blank" title="Telegram" class="social-link">
                        <i class="fab fa-telegram"></i>
                    </a>
                    <a href="https://instagram.com/imri_uz" target="_blank" title="Instagram" class="social-link">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://facebook.com/imri.uz" target="_blank" title="Facebook" class="social-link">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://youtube.com/@imri_uz" target="_blank" title="YouTube" class="social-link">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2><i class="fas fa-filter"></i> IMRS Filterlar</h2>

            <!-- Countries Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('countries')">
                    <div class="section-title">
                        <i class="fas fa-globe"></i>
                        <span>Davlatlar</span>
                    </div>
                    <div class="section-stats">
                        Mavjud: <span id="countries-available">0</span> |
                        <span class="selected-count">Tanlangan: <span id="countries-selected">0</span></span>
                    </div>
                </div>
                <div class="section-content" id="countries-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <input type="text" class="search-input" placeholder="Davlatlarni qidirish..." id="countrySearch">
                            <button class="control-btn" onclick="selectAllCountries()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllCountries()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="alphabet-filter" id="alphabetFilter"></div>
                    <div class="items-list">
                        <div class="countries-grid" id="countriesList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Davlatlar yuklanmoqda...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Series/Products Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('series')">
                    <div class="section-title">
                        <i class="fas fa-boxes"></i>
                        <span>Mahsulotlar</span>
                    </div>
                    <div class="section-stats">
                        Mavjud: <span id="series-available">0</span> |
                        <span class="selected-count">Tanlangan: <span id="series-selected">0</span></span>
                    </div>
                </div>
                <div class="section-content collapsed" id="series-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <input type="text" class="search-input" placeholder="Mahsulot nomi, HS kodi bo'yicha qidirish..." id="seriesSearch" oninput="performEnhancedSearch(this)">
                            <button class="control-btn" onclick="selectAllSeries()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllSeries()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="items-list" id="seriesList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Mahsulotlar yuklanmoqda...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Direction Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('trade-direction')">
                    <div class="section-title">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Savdo yo'nalishi</span>
                    </div>
                    <div class="section-stats">
                        <span class="selected-count">Tanlangan: <span id="trade-direction-selected">0</span></span>
                    </div>
                </div>
                <div class="section-content collapsed" id="trade-direction-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <button class="control-btn" onclick="selectAllTradeDirection()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllTradeDirection()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="trade-direction-grid" id="tradeDirectionGrid">
                        <div class="trade-direction-item" data-type="export">
                            <input type="checkbox" id="trade_export" value="export" onchange="updateTradeDirectionSelection()">
                            <label for="trade_export">Eksport</label>
                        </div>
                        <div class="trade-direction-item" data-type="import">
                            <input type="checkbox" id="trade_import" value="import" onchange="updateTradeDirectionSelection()">
                            <label for="trade_import">Import</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Years Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('years')">
                    <div class="section-title">
                        <i class="fas fa-calendar"></i>
                        <span>Yillar</span>
                    </div>
                    <div class="section-stats">
                        <span class="selected-count">Tanlangan: <span id="years-selected">0</span></span>
                    </div>
                </div>
                <div class="section-content collapsed" id="years-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <button class="control-btn" onclick="selectAllYears()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllYears()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="years-grid" id="yearsGrid"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Preview Panel -->
            <div class="preview-panel" id="previewPanel">
                <div class="preview-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h2>Ma'lumotlarni Filtrlash</h2>
                <p>Quyidagi bo'limlardan kamida bittasini tanlang va "Qidirish" tugmasini bosing.</p>
                <div class="requirements">
                    <div class="requirement" id="countries-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Davlatlar tanlang</span>
                    </div>
                    <div class="requirement" id="series-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Mahsulotlar tanlang</span>
                    </div>
                    <div class="requirement" id="trade-direction-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Savdo yo'nalishini tanlang</span>
                    </div>
                    <div class="requirement" id="years-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Yillar tanlang</span>
                    </div>
                </div>
                <button class="apply-btn" onclick="applyFilters()" id="applyBtn" disabled>
                    <i class="fas fa-search"></i> Qidirish
                </button>
            </div>

            <!-- Results Panel -->
            <div class="results-panel" id="resultsPanel">
                <div class="results-header">
                    <h3>
                        <i class="fas fa-table"></i>
                        Natijalar
                        <span class="results-count" id="resultsCount"></span>
                    </h3>
                    <div class="header-buttons">
                        <button class="control-btn" onclick="showExportOptions()">
                            <i class="fas fa-download"></i> Yuklab olish
                        </button>
                        <button class="control-btn" onclick="showPreview()">
                            <i class="fas fa-arrow-left"></i> Orqaga
                        </button>
                    </div>
                </div>

                <!-- Current Selection Summary -->
                <div class="current-selection-summary" id="currentSelectionSummary">
                    <div class="selection-tags">
                        <div class="selection-tag-group">
                            <strong>🌍 Tanlangan Davlatlar:</strong>
                            <span id="selectedCountriesSummary">Tanlanmagan</span>
                        </div>
                        <div class="selection-tag-group">
                            <strong>📦 Tanlangan Mahsulotlar:</strong>
                            <span id="selectedSeriesSummary">Tanlanmagan</span>
                        </div>
                        <div class="selection-tag-group">
                            <strong>🔄 Savdo yo'nalishi:</strong>
                            <span id="selectedTradeDirectionSummary">Tanlanmagan</span>
                        </div>
                        <div class="selection-tag-group">
                            <strong>📅 Tanlangan Yillar:</strong>
                            <span id="selectedYearsSummary">Tanlanmagan</span>
                        </div>
                    </div>
                    <div class="new-search-section">
                        <button class="apply-btn" onclick="applyFilters()" id="newSearchBtn">
                            <i class="fas fa-search"></i> Yangi Qidiruv
                        </button>
                        <p class="new-search-hint">Chapda filtrlarni o'zgartirib, yangi qidiruv amalga oshiring</p>
                    </div>
                </div>

                <!-- Chart Controls -->
                <div class="chart-controls" id="chartControls" style="display: none;">
                    <div class="controls-header">
                        <h4><i class="fas fa-chart-bar"></i> Ma'lumotlar ko'rinishi</h4>
                        <div class="view-toggles">
                            <button class="view-btn active" onclick="showView('table')" id="tableViewBtn">
                                <i class="fas fa-table"></i> Table
                            </button>
                            <button class="view-btn" onclick="showView('chart')" id="chartViewBtn">
                                <i class="fas fa-chart-bar"></i> Chart
                            </button>
                            <button class="view-btn" onclick="showView('metadata')" id="metadataViewBtn">
                                <i class="fas fa-info-circle"></i> Metadata
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Country Selector -->
                <div class="country-selector-section" id="countrySelectorSection" style="display: none;">
                    <div class="selector-header">
                        <h4><i class="fas fa-globe-americas"></i> Davlatni tanlang</h4>
                        <div class="selector-controls">
                            <select class="country-select" id="countrySelector" onchange="updateViewByCountry()">
                                <option value="all">Barcha davlatlar</option>
                            </select>
                            <button class="control-btn" onclick="resetCountryView()" title="Barchasini ko'rsatish">
                                <i class="fas fa-globe"></i>
                            </button>
                        </div>
                    </div>
                    <div class="selected-country-info" id="selectedCountryInfo" style="display: none;">
                        <div class="country-card">
                            <div class="country-flag">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="country-details">
                                <h5 id="selectedCountryName">-</h5>
                                <p id="selectedCountryStats">Ma'lumot yuklanmoqda...</p>
                            </div>
                            <div class="country-metrics">
                                <div class="metric">
                                    <span class="metric-label">Yozuvlar:</span>
                                    <span class="metric-value" id="countryRecords">0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Eksport:</span>
                                    <span class="metric-value" id="countryExport">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div id="resultsContent">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th><i class="fas fa-globe"></i> Davlat</th>
                                <th><i class="fas fa-box"></i> Mahsulot</th>
                                <th><i class="fas fa-barcode"></i> HS Kod</th>
                                <th><i class="fas fa-calendar"></i> Yil</th>
                                <th><i class="fas fa-exchange-alt"></i> Yo'nalish</th>
                                <th><i class="fas fa-balance-scale"></i> O'lchov</th>
                                <th><i class="fas fa-arrow-up"></i> Eksport Hajmi</th>
                                <th><i class="fas fa-dollar-sign"></i> Eksport Narxi</th>
                                <th><i class="fas fa-arrow-down"></i> Import Hajmi</th>
                                <th><i class="fas fa-dollar-sign"></i> Import Narxi</th>
                                <th><i class="fas fa-layer-group"></i> HS Gruppa</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>

                <!-- Chart Container -->
                <div class="chart-container" id="chartContainer" style="display: none;">
                    <div class="chart-header">
                        <h4><i class="fas fa-chart-line"></i> Grafik Tahlil</h4>
                        <div class="chart-controls-row">
                            <select class="chart-select" id="chartType" onchange="updateChart()">
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                            </select>
                            <select class="chart-select" id="chartMetric" onchange="updateChart()">
                                <option value="export_volume">Eksport Hajmi</option>
                                <option value="export_price">Eksport Narxi</option>
                                <option value="import_volume">Import Hajmi</option>
                                <option value="import_price">Import Narxi</option>
                            </select>
                            <button class="control-btn" onclick="exportChart()">
                                <i class="fas fa-download"></i> PNG
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="dataChart"></canvas>
                    </div>
                </div>

                <!-- Metadata Container -->
                <div class="metadata-container" id="metadataContainer" style="display: none;">
                    <div class="metadata-header">
                        <h4><i class="fas fa-database"></i> Ma'lumotlar Metadata</h4>
                    </div>
                    <div class="metadata-section-selector">
                        <div class="section-info">
                            <p><i class="fas fa-info-circle"></i>
                                <strong id="metadataCurrentView">Barcha davlatlar</strong> bo'yicha ma'lumotlar ko'rsatilmoqda
                            </p>
                        </div>
                    </div>
                    <div class="metadata-grid">
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Umumiy ma'lumotlar</h5>
                                <p id="totalRecords">0 ta yozuv</p>
                            </div>
                        </div>
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Davlatlar soni</h5>
                                <p id="uniqueCountries">0 ta davlat</p>
                            </div>
                        </div>
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Mahsulotlar soni</h5>
                                <p id="uniqueProducts">0 ta mahsulot</p>
                            </div>
                        </div>
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Yillar oralig'i</h5>
                                <p id="yearRange">-</p>
                            </div>
                        </div>
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-arrow-up" style="color: var(--success);"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Umumiy eksport</h5>
                                <p id="totalExport">0</p>
                            </div>
                        </div>
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-arrow-down" style="color: var(--error);"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Umumiy import</h5>
                                <p id="totalImport">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="detailed-stats">
                        <h5><i class="fas fa-chart-pie"></i> Davlatlar bo'yicha taqsimot</h5>
                        <div class="stats-table" id="countryStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="simple-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <span>IMRS - Tashqi Savdo Tahlili</span>
                </div>
            </div>
            <div class="footer-info">
                <p>O'zbekiston Respublikasi Vazirlar Mahkamasi huzuridagi</p>
                <p><strong>Makroiqtisodiy va xududiy tahlil instituti</strong></p>
                <div class="copyright">
                    &copy; 2024 IMRS. Barcha huquqlar himoyalangan.
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global Variables (optimized)
        let selectedCountries=[], selectedSeries=[], selectedYears=[], selectedTradeDirections=[];
        let currentLanguage='uz', currentChart=null, currentData=[], availableCountries=[];
        let selectedCountryForView='all', countryFilteredData=[], activeAlphabetFilter=null;
        let allCountriesData=[], allSeriesData=[], allHSCodesByType={hs_2_codes:[],hs_4_codes:[],hs_6_codes:[],hs_10_codes:[]};
        
        const translations = {
            uz: {title:'IMRS Filterlar',countries:'Davlatlar',products:'Mahsulotlar',tradeDirection:'Savdo yo\'nalishi',years:'Yillar',search:'Qidirish',searchPlaceholder:'Ma\'lumotlarni qidirish...'},
            ru: {title:'ИМРС Фильтры',countries:'Страны',products:'Продукты',tradeDirection:'Направление торговли',years:'Годы',search:'Поиск',searchPlaceholder:'Поиск данных...'},
            en: {title:'IMRS Filters',countries:'Countries',products:'Products',tradeDirection:'Trade Direction',years:'Years',search:'Search',searchPlaceholder:'Search data...'}
        };

        // Enhanced Search Functions (optimized)
        function performEnhancedSearch(input) {
            const term = input.value.trim();
            if (!term.length) { displayAllSeries(); hideHSCodeSuggestions(); return; }
            if (!/^\d+$/.test(term)) { displayNoResults('Faqat raqamlarni kiriting'); return; }
            if (term.length >= 2) performBackendSearch(term); else performLocalSearchAllHS(term);
        }

        async function performBackendSearch(term) {
            try {
                document.getElementById('seriesList').innerHTML = '<div class="loading"><div class="spinner"></div><p>HS kod qidirilmoqda...</p></div>';
                const res = await fetch(`/api/search-products?hs_code=${encodeURIComponent(term)}`);
                const data = await res.json();
                if (data.success && data.results.length) {
                    displayFilteredSeries(data.results);
                    showToast('Topildi!', `${data.results.length} ta mahsulot`, 'success');
                } else {
                    document.getElementById('seriesList').innerHTML = '<div class="no-data">Mahsulot topilmadi</div>';
                }
            } catch(e) { performLocalSearchAllHS(term); }
        }

        function performLocalSearchAllHS(term) {
            const filtered = allSeriesData.filter(item => 
                [item.hs_2_code, item.hs_4_code, item.hs_6_code, item.hs_10_code]
                .some(code => String(code).trim() === term)
            );
            displayFilteredSeries(filtered);
            if (!filtered.length) document.getElementById('seriesList').innerHTML = '<div class="no-data">Natija topilmadi</div>';
        }

        async function loadAllHSCodes() {
            try {
                const res = await fetch('/api/all-hs-codes');
                const data = await res.json();
                if (data.success) {
                    allHSCodesByType = data.by_type;
                    window.allHSCodes = data.all_codes;
                    initializeHSCodeAutocomplete();
                }
            } catch(e) { console.error('HS kodlar yuklanmadi:', e); }
        }

        function initializeHSCodeAutocomplete() {
            const input = document.getElementById('seriesSearch');
            if (!input || !window.allHSCodes) return;
            input.addEventListener('input', function(e) {
                const val = e.target.value.trim();
                if (val.length >= 1 && /^\d+$/.test(val)) {
                    const suggestions = getHSCodeSuggestions(val);
                    if (suggestions.length) showHSCodeSuggestions(suggestions, val);
                    else hideHSCodeSuggestions();
                } else hideHSCodeSuggestions();
            });
        }

        function getHSCodeSuggestions(term) {
            const suggestions = [];
            const len = term.length;
            let types = [];
            if (len <= 2) types = ['hs_2_codes'];
            else if (len <= 4) types = ['hs_2_codes', 'hs_4_codes'];
            else if (len <= 6) types = ['hs_4_codes', 'hs_6_codes'];
            else types = ['hs_6_codes', 'hs_10_codes'];
            
            types.forEach(type => {
                if (allHSCodesByType[type]) {
                    allHSCodesByType[type].filter(code => String(code).startsWith(term))
                        .slice(0, 5).forEach(code => suggestions.push({code, type, typeName: getHSTypeDisplayName(type)}));
                }
            });
            return suggestions.slice(0, 15);
        }

        function getHSTypeDisplayName(type) {
            return {hs_2_codes:'HS-2',hs_4_codes:'HS-4',hs_6_codes:'HS-6',hs_10_codes:'HS-10'}[type] || type;
        }

        function showHSCodeSuggestions(suggestions, term) {
            let dropdown = document.getElementById('hsCodeSuggestions');
            if (!dropdown) {
                dropdown = document.createElement('div');
                dropdown.id = 'hsCodeSuggestions';
                dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:var(--bg-secondary);border:2px solid var(--border-color);border-top:none;border-radius:0 0 10px 10px;box-shadow:0 8px 25px var(--shadow-dark);max-height:300px;overflow-y:auto;z-index:1000;';
                const container = document.getElementById('seriesSearch').parentNode;
                container.style.position = 'relative';
                container.appendChild(dropdown);
            }
            
            let html = '';
            let currentType = '';
            suggestions.forEach(s => {
                if (s.type !== currentType) {
                    currentType = s.type;
                    html += `<div style="padding:8px 16px;background:var(--bg-tertiary);font-weight:600;color:var(--text-primary);font-size:.85rem;border-bottom:1px solid var(--border-color);">${s.typeName} kodlari</div>`;
                }
                const highlighted = String(s.code).replace(new RegExp(term, 'g'), `<strong style="color:var(--accent-primary);">${term}</strong>`);
                const exact = String(s.code) === term;
                html += `<div class="hs-suggestion" onclick="selectHSCode('${s.code}')" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border-light);transition:all .2s;${exact?'background:rgba(59,130,246,.1);':''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-family:monospace;font-weight:600;font-size:.95rem;">${highlighted}</span>
                        <span style="font-size:.75rem;color:var(--text-muted);background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;">${s.typeName}</span>
                    </div>
                    ${exact?'<div style="font-size:.75rem;color:var(--success);margin-top:2px;">✓ Aniq mos kelish</div>':''}
                </div>`;
            });
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectHSCode(code) {
            document.getElementById('seriesSearch').value = code;
            hideHSCodeSuggestions();
            performBackendSearch(code);
        }

        function hideHSCodeSuggestions() {
            const dropdown = document.getElementById('hsCodeSuggestions');
            if (dropdown) dropdown.style.display = 'none';
        }

        function displayNoResults(msg) {
            document.getElementById('seriesList').innerHTML = `<div class="no-data">${msg}</div>`;
        }

        function displayFilteredSeries(filtered) {
            const list = document.getElementById('seriesList');
            if (!filtered.length) { list.innerHTML = '<div class="no-data">Qidiruv bo\'yicha natija topilmadi</div>'; return; }
            let html = '';
            filtered.forEach((item, i) => {
                const name = item.name || item.product_name || 'Noma\'lum mahsulot';
                const short = name.length > 70 ? name.substring(0, 67) + '...' : name;
                const selected = selectedSeries.includes(name);
                const hsInfo = getHSCodeInfo(item);
                html += `<div class="filter-item">
                    <div class="filter-item-icon">!</div>
                    <input type="checkbox" id="series_filtered_${i}" value="${name}" onchange="updateSeriesSelection()" ${selected?'checked':''}>
                    <label for="series_filtered_${i}" title="${name}">${short}${hsInfo?`<br><small style="color:var(--text-muted);">${hsInfo}</small>`:''}</label>
                </div>`;
            });
            list.innerHTML = html;
        }

        function getHSCodeInfo(item) {
            const codes = [];
            if (item.hs_2_code) codes.push(`HS-2: ${item.hs_2_code}`);
            if (item.hs_4_code) codes.push(`HS-4: ${item.hs_4_code}`);
            if (item.hs_6_code) codes.push(`HS-6: ${item.hs_6_code}`);
            if (item.hs_10_code) codes.push(`HS-10: ${item.hs_10_code}`);
            return codes.length ? codes.join(' | ') : null;
        }

        function displayAllSeries() { displayFilteredSeries(allSeriesData); }

        // Data Loading (optimized)
        async function loadFilterData() {
            try {
                console.log('📋 Filter data yuklanmoqda...');
                const res = await fetch('/api/filter-options');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                if (data.success && data.countries && data.products) {
                    populateCountries(data.countries);
                    populateSeries(data.products);
                    if (data.pagination?.total) document.getElementById('series-available').textContent = data.pagination.total;
                    if (data.years) generateYearsFromDB(data.years); else generateYears();
                    await loadAllHSCodes();
                    showToast('✅ Yuklandi!', `${data.countries.length} davlat, ${data.products.length} mahsulot`, 'success');
                } else throw new Error('Noto\'g\'ri format');
            } catch(e) {
                console.error('❌ Database xatoligi:', e);
                // Fallback test data
                populateCountries(['Germany','Russian Federation','Kazakhstan','China','USA','Turkey','Uzbekistan','France','Italy','Spain','Brazil','India','Japan']);
                const testData = [
                    {name:'Live animals and animal products',hs_2_code:'01',hs_4_code:'0102',hs_6_code:'010221',hs_10_code:'0102211000'},
                    {name:'Vegetable products',hs_2_code:'02',hs_4_code:'0201',hs_6_code:'020110',hs_10_code:'0201100000'},
                    {name:'Mineral products',hs_2_code:'25',hs_4_code:'2501',hs_6_code:'250100',hs_10_code:'2501001000'},
                    {name:'Machinery and mechanical appliances',hs_2_code:'84',hs_4_code:'8401',hs_6_code:'840110',hs_10_code:'8401101000'}
                ];
                populateSeries(testData);
                generateYears();
                showToast('⚠️ Test rejimi', 'Test ma\'lumotlari yuklandi', 'info');
            }
        }

        function populateCountries(countries) {
            allCountriesData = countries.sort();
            document.getElementById('countries-available').textContent = countries.length;
            generateAlphabetFilter(countries);
            displayCountries(countries);
        }

        function populateSeries(series) {
            allSeriesData = series.map(item => typeof item === 'string' ? {name:item,product_name:item,hs_2_code:null,hs_4_code:null,hs_6_code:null,hs_10_code:null} : item);
            document.getElementById('series-available').textContent = allSeriesData.length;
            displayAllSeries();
        }

        function generateAlphabetFilter(countries) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            const available = new Set(countries.map(c => c.charAt(0).toUpperCase()).filter(l => alphabet.includes(l)));
            let html = '<button class="alphabet-btn active" onclick="filterByAlphabet(null)" title="Barcha davlatlar">All</button>';
            alphabet.forEach(letter => {
                const isAvailable = available.has(letter);
                if (isAvailable) html += `<button class="alphabet-btn" onclick="filterByAlphabet('${letter}')" title="${letter} harfi">${letter}</button>`;
                else html += `<button class="alphabet-btn disabled" title="Bu harf yo'q">${letter}</button>`;
            });
            document.getElementById('alphabetFilter').innerHTML = html;
        }

        function filterByAlphabet(letter) {
            activeAlphabetFilter = letter;
            document.querySelectorAll('.alphabet-btn').forEach(btn => btn.classList.remove('active'));
            if (letter === null) {
                document.querySelector('.alphabet-btn[onclick="filterByAlphabet(null)"]').classList.add('active');
                displayCountries(allCountriesData);
            } else {
                document.querySelector(`.alphabet-btn[onclick="filterByAlphabet('${letter}')"]`).classList.add('active');
                displayCountries(allCountriesData.filter(c => c.charAt(0).toUpperCase() === letter));
            }
            document.getElementById('countrySearch').value = '';
        }

        function displayCountries(countries) {
            const list = document.getElementById('countriesList');
            if (!countries.length) { list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:20px;">Ma\'lumot topilmadi</div>'; return; }
            let html = '';
            countries.forEach(country => {
                const id = `country_${allCountriesData.indexOf(country)}`;
                html += `<div class="filter-item">
                    <div class="filter-item-icon">!</div>
                    <input type="checkbox" id="${id}" value="${country}" onchange="updateCountriesSelection()" ${selectedCountries.includes(country)?'checked':''}>
                    <label for="${id}" title="${country}">${country}</label>
                </div>`;
            });
            list.innerHTML = html;
        }

        function initializeCountrySearch() {
            const search = document.getElementById('countrySearch');
            if (search) {
                search.addEventListener('input', function(e) {
                    const term = e.target.value.toLowerCase();
                    if (!term) {
                        if (activeAlphabetFilter) filterByAlphabet(activeAlphabetFilter);
                        else displayCountries(allCountriesData);
                    } else {
                        activeAlphabetFilter = null;
                        document.querySelectorAll('.alphabet-btn').forEach(btn => btn.classList.remove('active'));
                        displayCountries(allCountriesData.filter(c => c.toLowerCase().includes(term)));
                    }
                });
            }
        }

        function generateYearsFromDB(years) {
            const grid = document.getElementById('yearsGrid');
            let html = '';
            years.forEach(year => {
                html += `<div class="year-item">
                    <input type="checkbox" id="year_${year}" value="${year}" onchange="updateYearsSelection()">
                    <label for="year_${year}">${year}</label>
                </div>`;
            });
            grid.innerHTML = html;
        }

        function generateYears() {
            const grid = document.getElementById('yearsGrid');
            const currentYear = new Date().getFullYear();
            let html = '';
            for (let i = 0; i < 10; i++) {
                const year = currentYear - i;
                html += `<div class="year-item">
                    <input type="checkbox" id="year_${year}" value="${year}" onchange="updateYearsSelection()">
                    <label for="year_${year}">${year}</label>
                </div>`;
            }
            grid.innerHTML = html;
        }

        // Section Management (optimized)
        function toggleSection(name) {
            const content = document.getElementById(name + '-content');
            const isCollapsed = content.classList.contains('collapsed');
            document.querySelectorAll('.section-content').forEach(el => {
                if (el.id !== name + '-content') el.classList.add('collapsed');
            });
            if (isCollapsed) content.classList.remove('collapsed');
            else content.classList.add('collapsed');
        }

        // Selection Updates (optimized)
        function updateCountriesSelection() {
            selectedCountries = Array.from(document.querySelectorAll('#countriesList input[type="checkbox"]:checked')).map(cb => cb.value);
            document.getElementById('countries-selected').textContent = selectedCountries.length;
            updateRequirements();
        }

        function updateSeriesSelection() {
            selectedSeries = Array.from(document.querySelectorAll('input[id^="series_"]:checked')).map(cb => cb.value);
            document.getElementById('series-selected').textContent = selectedSeries.length;
            updateRequirements();
        }

        function updateTradeDirectionSelection() {
            selectedTradeDirections = Array.from(document.querySelectorAll('input[id^="trade_"]:checked')).map(cb => cb.value);
            document.getElementById('trade-direction-selected').textContent = selectedTradeDirections.length;
            updateRequirements();
        }

        function updateYearsSelection() {
            selectedYears = Array.from(document.querySelectorAll('input[id^="year_"]:checked')).map(cb => parseInt(cb.value));
            document.getElementById('years-selected').textContent = selectedYears.length;
            updateRequirements();
        }

        function updateRequirements() {
            const reqs = ['countries','series','trade-direction','years'];
            const selections = [selectedCountries.length, selectedSeries.length, selectedTradeDirections.length, selectedYears.length];
            reqs.forEach((req, i) => {
                const el = document.getElementById(req + '-requirement');
                if (selections[i] > 0) {
                    el.classList.add('completed');
                    el.querySelector('i').className = 'fas fa-check-circle';
                } else {
                    el.classList.remove('completed');
                    el.querySelector('i').className = 'fas fa-circle';
                }
            });
            const hasSelections = selections.some(s => s > 0);
            document.getElementById('applyBtn').disabled = !hasSelections;
        }

        // Select All Functions (optimized)
        function selectAllCountries() { document.querySelectorAll('input[id^="country_"]').forEach(cb => cb.checked = true); updateCountriesSelection(); }
        function clearAllCountries() { document.querySelectorAll('input[id^="country_"]').forEach(cb => cb.checked = false); updateCountriesSelection(); }
        function selectAllSeries() { document.querySelectorAll('input[id^="series_"]').forEach(cb => cb.checked = true); updateSeriesSelection(); }
        function clearAllSeries() { document.querySelectorAll('input[id^="series_"]').forEach(cb => cb.checked = false); updateSeriesSelection(); }
        function selectAllTradeDirection() { document.querySelectorAll('input[id^="trade_"]').forEach(cb => cb.checked = true); updateTradeDirectionSelection(); }
        function clearAllTradeDirection() { document.querySelectorAll('input[id^="trade_"]').forEach(cb => cb.checked = false); updateTradeDirectionSelection(); }
        function selectAllYears() { document.querySelectorAll('input[id^="year_"]').forEach(cb => cb.checked = true); updateYearsSelection(); }
        function clearAllYears() { document.querySelectorAll('input[id^="year_"]').forEach(cb => cb.checked = false); updateYearsSelection(); }

        // Language & Theme (optimized)
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('langDropdown');
            dropdown.classList.toggle('show');
            document.addEventListener('click', function close(e) {
                if (!e.target.closest('.language-selector')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', close);
                }
            });
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            const flags = {uz:'https://flagcdn.com/w20/uz.png',ru:'https://flagcdn.com/w20/ru.png',en:'https://flagcdn.com/w20/gb.png'};
            document.querySelector('.lang-current').innerHTML = `<img src="${flags[lang]}" alt="${lang.toUpperCase()}" class="flag-icon"><span>${lang.toUpperCase()}</span><i class="fas fa-chevron-down"></i>`;
            document.getElementById('langDropdown').classList.remove('show');
            updateInterfaceLanguage();
            showToast('🌐 Til', `${lang.toUpperCase()} tiliga o\'tkazildi`, 'info');
        }

        function updateInterfaceLanguage() {
            const t = translations[currentLanguage];
            const h2 = document.querySelector('h2');
            if (h2) h2.innerHTML = `<i class="fas fa-filter"></i> ${t.title}`;
            const sections = document.querySelectorAll('.section-title span');
            if (sections[0]) sections[0].textContent = t.countries;
            if (sections[1]) sections[1].textContent = t.products;
            if (sections[2]) sections[2].textContent = t.tradeDirection;
            if (sections[3]) sections[3].textContent = t.years;
            const headerSearch = document.getElementById('headerSearch');
            if (headerSearch) headerSearch.placeholder = t.searchPlaceholder;
            const applyBtn = document.getElementById('applyBtn');
            if (applyBtn) applyBtn.innerHTML = `<i class="fas fa-search"></i> ${t.search}`;
            const newSearchBtn = document.getElementById('newSearchBtn');
            if (newSearchBtn) newSearchBtn.innerHTML = `<i class="fas fa-search"></i> ${t.search}`;
        }

        function performHeaderSearch() {
            const query = document.getElementById('headerSearch').value;
            if (query.trim()) showToast('🔍 Qidiruv', `"${query}" bo\'yicha qidiruv`, 'info');
        }

        function initializeLanguage() {
            const saved = localStorage.getItem('language') || 'uz';
            if (saved !== 'uz') changeLanguage(saved);
        }

        function toggleTheme() {
            const html = document.documentElement;
            const toggle = document.getElementById('themeToggle');
            const current = html.getAttribute('data-theme');
            if (current === 'dark') {
                html.removeAttribute('data-theme');
                toggle.classList.remove('active');
                localStorage.setItem('theme', 'light');
                showToast('🌞 Yorug\'lik', 'Yorug\'lik rejimi', 'info');
            } else {
                html.setAttribute('data-theme', 'dark');
                toggle.classList.add('active');
                localStorage.setItem('theme', 'dark');
                showToast('🌙 Qorong\'u', 'Qorong\'u rejim', 'info');
            }
        }

        function initializeTheme() {
            const saved = localStorage.getItem('theme');
            const toggle = document.getElementById('themeToggle');
            if (saved === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                toggle.classList.add('active');
            }
        }

        // Apply Filters (optimized)
        async function applyFilters() {
            const btns = [document.getElementById('applyBtn'), document.getElementById('newSearchBtn')];
            btns.forEach(btn => {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Qidirilmoqda...';
                    btn.disabled = true;
                }
            });

            try {
                const formData = new FormData();
                selectedCountries.forEach(c => formData.append('countries', c));
                selectedSeries.forEach(s => formData.append('products', s));
                selectedTradeDirections.forEach(d => formData.append('trade_directions', d));
                selectedYears.forEach(y => formData.append('years', y));

                const res = await fetch('/api/get-data', {method: 'POST', body: formData});
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const result = await res.json();

                if (result.success && result.data) {
                    const filtered = filterDataByTradeDirection(result.data);
                    displayRealResults(filtered);
                    updateSelectionSummary();
                    showResults(filtered.length);
                    showToast('🎉 Muvaffaqiyat!', `${filtered.length} ta ma\'lumot`, 'success');
                } else throw new Error(result.error || 'Ma\'lumot topilmadi');
            } catch(e) {
                console.error('❌ Filter xatoligi:', e);
                const sample = generateEnhancedSampleResults();
                const filtered = filterDataByTradeDirection(sample);
                displayRealResults(filtered);
                updateSelectionSummary();
                showResults('Test ma\'lumotlari');
                showToast('⚠️ Test', 'Test natijalar', 'info');
            } finally {
                btns.forEach(btn => {
                    if (btn) {
                        btn.innerHTML = btn.id === 'applyBtn' ? '<i class="fas fa-search"></i> Qidirish' : '<i class="fas fa-search"></i> Yangi Qidiruv';
                        btn.disabled = false;
                    }
                });
            }
        }

        function showResults(count) {
            document.getElementById('previewPanel').style.display = 'none';
            document.getElementById('resultsPanel').style.display = 'block';
            document.getElementById('resultsCount').textContent = `(${count} ta natija)`;
        }

        function filterDataByTradeDirection(data) {
            if (!selectedTradeDirections.length) return data;
            return data.filter(item => {
                let matches = false;
                selectedTradeDirections.forEach(dir => {
                    if (dir === 'export' && (item.export_volume > 0 || item.export_price > 0)) {
                        matches = true;
                        item.import_volume = 0;
                        item.import_price = 0;
                    }
                    if (dir === 'import' && (item.import_volume > 0 || item.import_price > 0)) {
                        matches = true;
                        item.export_volume = 0;
                        item.export_price = 0;
                    }
                });
                return matches;
            });
        }

        function generateEnhancedSampleResults() {
            return [
                {country:'Germany',product:'Machinery',hs_code:'8401',year:2023,measure:'kg',export_volume:15000000,export_price:45000000,import_volume:8000000,import_price:25000000,hs_group:'Nuclear reactors'},
                {country:'China',product:'Electrical machinery',hs_code:'8501',year:2023,measure:'kg',export_volume:25000000,export_price:80000000,import_volume:12000000,import_price:35000000,hs_group:'Electrical machinery'},
                {country:'Russian Federation',product:'Mineral fuels',hs_code:'2701',year:2023,measure:'tons',export_volume:0,export_price:0,import_volume:50000000,import_price:120000000,hs_group:'Mineral fuels'},
                {country:'Kazakhstan',product:'Cereals',hs_code:'1001',year:2023,measure:'tons',export_volume:5000000,export_price:15000000,import_volume:0,import_price:0,hs_group:'Cereals'}
            ];
        }

        function displayRealResults(data) {
            currentData = data;
            countryFilteredData = data;
            generateTableHeaders();
            updateChartMetricOptions();
            const tbody = document.getElementById('resultsTableBody');
            let html = '';
            if (!data.length) {
                html = `<tr><td colspan="${calculateTableColspan()}" class="no-data">Ma'lumot topilmadi</td></tr>`;
            } else {
                data.forEach(item => html += generateTableRow(item));
            }
            tbody.innerHTML = html;
            showChartControls();
            showCountrySelector();
        }

        function generateTableHeaders() {
            const thead = document.querySelector('.results-table thead tr');
            if (!thead) return;
            let headers = `<th><i class="fas fa-globe"></i> Davlat</th><th><i class="fas fa-box"></i> Mahsulot</th><th><i class="fas fa-barcode"></i> HS Kod</th><th><i class="fas fa-calendar"></i> Yil</th><th><i class="fas fa-exchange-alt"></i> Yo'nalish</th><th><i class="fas fa-balance-scale"></i> O'lchov</th>`;
            if (needsExportColumns()) headers += `<th><i class="fas fa-arrow-up"></i> Eksport Hajmi</th><th><i class="fas fa-dollar-sign"></i> Eksport Narxi</th>`;
            if (needsImportColumns()) headers += `<th><i class="fas fa-arrow-down"></i> Import Hajmi</th><th><i class="fas fa-dollar-sign"></i> Import Narxi</th>`;
            headers += `<th><i class="fas fa-layer-group"></i> HS Gruppa</th>`;
            thead.innerHTML = headers;
        }

        function updateChartMetricOptions() {
            const select = document.getElementById('chartMetric');
            let options = '';
            if (needsExportColumns()) options += `<option value="export_volume">Eksport Hajmi</option><option value="export_price">Eksport Narxi</option>`;
            if (needsImportColumns()) options += `<option value="import_volume">Import Hajmi</option><option value="import_price">Import Narxi</option>`;
            if (!options) options = '<option value="">Savdo yo\'nalishini tanlang</option>';
            select.innerHTML = options;
        }

        function generateTableRow(item) {
            let row = `<tr><td><strong>${item.country||item.trading_partner||'-'}</strong></td><td title="${item.name||item.product_name||'-'}">${truncateText(item.name||item.product_name||'-',40)}</td><td>${item.code||item.hs_code||item.hs_10_code||'-'}</td><td><span class="year-badge">${item.year||'-'}</span></td><td>`;
            let direction = '';
            if ((selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) && (item.export_volume > 0 || item.export_price > 0)) {
                direction += '<span style="color:var(--success);">📈 Eksport</span>';
            }
            if ((selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) && (item.import_volume > 0 || item.import_price > 0)) {
                if (direction) direction += ' / ';
                direction += '<span style="color:var(--error);">📉 Import</span>';
            }
            row += `${direction||'-'}</td><td><strong>${item.measure||'-'}</strong></td>`;
            if (needsExportColumns()) row += `<td>${formatPrice(item.export_volume||0)}</td><td>${formatPrice(item.export_price||0)}</td>`;
            if (needsImportColumns()) row += `<td>${formatPrice(item.import_volume||0)}</td><td>${formatPrice(item.import_price||0)}</td>`;
            row += `<td title="${item.hs_group||'-'}">${truncateText(item.hs_group||'-',30)}</td></tr>`;
            return row;
        }

        function calculateTableColspan() {
            let colspan = 6;
            if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('export') && !selectedTradeDirections.includes('import')) colspan += 2;
            else if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('import') && !selectedTradeDirections.includes('export')) colspan += 2;
            else colspan += 4;
            return colspan + 1;
        }

        function needsExportColumns() { return selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export'); }
        function needsImportColumns() { return selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import'); }

        function showChartControls() { document.getElementById('chartControls').style.display = 'block'; }
        function showCountrySelector() { document.getElementById('countrySelectorSection').style.display = 'block'; populateCountrySelector(); }

        function populateCountrySelector() {
            if (!currentData.length) return;
            availableCountries = [...new Set(currentData.map(item => item.country || item.trading_partner))].filter(Boolean).sort();
            const selector = document.getElementById('countrySelector');
            selector.innerHTML = '<option value="all">Barcha davlatlar</option>';
            availableCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                selector.appendChild(option);
            });
            if (availableCountries.length > 0) {
                selector.value = availableCountries[0];
                selectedCountryForView = availableCountries[0];
                updateViewByCountry();
            }
        }

        function updateViewByCountry() {
            const selector = document.getElementById('countrySelector');
            selectedCountryForView = selector.value;
            if (selectedCountryForView === 'all') {
                countryFilteredData = currentData;
                document.getElementById('selectedCountryInfo').style.display = 'none';
            } else {
                countryFilteredData = currentData.filter(item => (item.country || item.trading_partner) === selectedCountryForView);
                showSelectedCountryInfo();
            }
            updateMetadataCurrentView();
            updateTableView();
            const activeView = document.querySelector('.view-btn.active').id.replace('ViewBtn', '');
            if (activeView === 'chart') updateChartWithCountryData();
            else if (activeView === 'metadata') updateMetadataWithCountryData();
        }

        function showSelectedCountryInfo() {
            const info = document.getElementById('selectedCountryInfo');
            const name = document.getElementById('selectedCountryName');
            const stats = document.getElementById('selectedCountryStats');
            const records = document.getElementById('countryRecords');
            const exportVal = document.getElementById('countryExport');
            const totalRecords = countryFilteredData.length;
            const totalExport = countryFilteredData.reduce((sum, item) => sum + (parseFloat(item.export_volume) || 0), 0);
            const uniqueProducts = [...new Set(countryFilteredData.map(item => item.name || item.product_name))].filter(Boolean).length;
            name.textContent = selectedCountryForView;
            stats.textContent = `${uniqueProducts} xil mahsulot bo'yicha ma'lumotlar`;
            records.textContent = totalRecords.toLocaleString();
            exportVal.textContent = formatNumber(totalExport);
            info.style.display = 'block';
        }

        function resetCountryView() {
            document.getElementById('countrySelector').value = 'all';
            updateViewByCountry();
            showToast('Barcha davlatlar', 'Barcha davlatlar ko\'rsatilmoqda', 'info');
        }

        function updateMetadataCurrentView() {
            const view = document.getElementById('metadataCurrentView');
            if (view) view.textContent = selectedCountryForView === 'all' ? 'Barcha davlatlar' : selectedCountryForView;
        }

        function updateTableView() {
            generateTableHeaders();
            const tbody = document.getElementById('resultsTableBody');
            let html = '';
            if (!countryFilteredData.length) {
                html = `<tr><td colspan="${calculateTableColspan()}" class="no-data">Tanlangan davlat uchun ma'lumot topilmadi</td></tr>`;
            } else {
                countryFilteredData.forEach(item => html += generateTableRow(item));
            }
            tbody.innerHTML = html;
            const count = document.getElementById('resultsCount');
            count.textContent = selectedCountryForView === 'all' ? `(${countryFilteredData.length} ta natija)` : `(${selectedCountryForView}: ${countryFilteredData.length} ta natija)`;
        }

        function showView(type) {
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(type + 'ViewBtn').classList.add('active');
            document.getElementById('resultsContent').style.display = type === 'table' ? 'block' : 'none';
            document.getElementById('chartContainer').style.display = type === 'chart' ? 'block' : 'none';
            document.getElementById('metadataContainer').style.display = type === 'metadata' ? 'block' : 'none';
            if (type === 'table') updateTableView();
            else if (type === 'chart') updateChartWithCountryData();
            else if (type === 'metadata') updateMetadataWithCountryData();
        }

        function showPreview() {
            document.getElementById('resultsPanel').style.display = 'none';
            document.getElementById('previewPanel').style.display = 'block';
        }

        function updateSelectionSummary() {
            const summaries = [
                {id: 'selectedCountriesSummary', data: selectedCountries, max: 3},
                {id: 'selectedSeriesSummary', data: selectedSeries.map(s => s.length > 30 ? s.substring(0, 27) + '...' : s), max: 2},
                {id: 'selectedTradeDirectionSummary', data: selectedTradeDirections.map(d => d === 'export' ? 'Eksport' : 'Import'), max: 2},
                {id: 'selectedYearsSummary', data: selectedYears.sort((a,b) => b-a), max: 5}
            ];
            
            summaries.forEach(({id, data, max}) => {
                const el = document.getElementById(id);
                if (!data.length) {
                    el.textContent = 'Tanlanmagan';
                    el.style.color = 'var(--text-muted)';
                } else if (data.length <= max) {
                    el.textContent = data.join(', ');
                    el.style.color = 'var(--accent-primary)';
                } else {
                    el.textContent = `${data.slice(0, max-1).join(', ')} va yana ${data.length - (max-1)} ta`;
                    el.style.color = 'var(--accent-primary)';
                }
            });
        }

        // Chart Functions (optimized)
        function updateChartWithCountryData() {
            const type = document.getElementById('chartType').value;
            const metric = document.getElementById('chartMetric').value;
            if (!countryFilteredData.length || !metric) {
                document.querySelector('.chart-content').innerHTML = '<div class="chart-loading"><div class="spinner"></div><p>Ma\'lumot yoki metrik tanlanmagan</p></div>';
                return;
            }
            if (currentChart) currentChart.destroy();
            const content = document.querySelector('.chart-content');
            if (!document.getElementById('dataChart')) content.innerHTML = '<canvas id="dataChart"></canvas>';
            const ctx = document.getElementById('dataChart').getContext('2d');
            const chartData = selectedCountryForView === 'all' ? prepareCountryComparisonData(metric) : prepareCountryTimelineData(countryFilteredData, metric);
            const config = {
                type: type,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {mode: 'point', intersect: true},
                    plugins: {
                        title: {display: true, text: getChartTitle(metric), font: {size: 16, weight: 'bold'}, color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')},
                        legend: {display: true, position: 'top', labels: {color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'), font: {size: 11}, usePointStyle: true, padding: 15}},
                        tooltip: {
                            mode: 'point',
                            intersect: true,
                            callbacks: {
                                title: function(context) { return context.length > 0 ? `${context[0].label}-yil` : ''; },
                                label: function(context) {
                                    const fullName = context.dataset.fullName || context.dataset.label;
                                    const displayName = fullName.length > 40 ? fullName.substring(0, 37) + '...' : fullName;
                                    return `${displayName}: ${formatChartNumber(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: type !== 'pie' ? {
                        x: {display: true, title: {display: true, text: 'Yillar', color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')}, ticks: {color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted')}},
                        y: {display: true, title: {display: true, text: getMetricLabel(metric), color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')}, ticks: {color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'), callback: function(value) { return formatChartNumber(value); }}}
                    } : {}
                }
            };
            currentChart = new Chart(ctx, config);
        }

        function prepareCountryComparisonData(metric) {
            const countryData = {};
            countryFilteredData.forEach(item => {
                const country = item.country || item.trading_partner || 'Unknown';
                const value = parseFloat(item[metric]) || 0;
                if (!countryData[country]) countryData[country] = 0;
                countryData[country] += value;
            });
            const sorted = Object.entries(countryData).filter(([c, v]) => v > 0).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#F97316', '#06B6D4', '#84CC16', '#EC4899', '#6B7280'];
            return {
                labels: sorted.map(item => item[0]),
                datasets: [{
                    label: getMetricLabel(metric),
                    data: sorted.map(item => item[1]),
                    backgroundColor: colors.slice(0, sorted.length),
                    borderColor: colors.slice(0, sorted.length),
                    borderWidth: 2
                }]
            };
        }

        function prepareCountryTimelineData(data, metric) {
            const productData = {};
            data.forEach(item => {
                const name = item.name || item.product_name || 'Noma\'lum';
                const year = item.year || 'Unknown';
                const value = parseFloat(item[metric]) || 0;
                if (value > 0) {
                    if (!productData[name]) productData[name] = {};
                    if (!productData[name][year]) productData[name][year] = 0;
                    productData[name][year] += value;
                }
            });
            const datasets = [];
            const colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#F97316', '#06B6D4', '#84CC16', '#EC4899', '#6B7280'];
            let colorIndex = 0;
            Object.entries(productData).forEach(([name, yearData]) => {
                const validPoints = Object.entries(yearData).filter(([y, v]) => v > 0).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
                if (validPoints.length > 0) {
                    const shortName = name.length > 30 ? name.substring(0, 27) + '...' : name;
                    datasets.push({
                        label: shortName,
                        fullName: name,
                        data: validPoints,
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '20',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        parsing: {xAxisKey: '0', yAxisKey: '1'}
                    });
                    colorIndex++;
                }
            });
            const allYears = new Set();
            datasets.forEach(d => d.data.forEach(p => allYears.add(p[0])));
            datasets.sort((a, b) => {
                const sumA = a.data.reduce((sum, point) => sum + point[1], 0);
                const sumB = b.data.reduce((sum, point) => sum + point[1], 0);
                return sumB - sumA;
            });
            return {labels: Array.from(allYears).sort(), datasets: datasets.slice(0, 10)};
        }

        function getChartTitle(metric) {
            const titles = {export_volume:'Eksport Hajmi',export_price:'Eksport Narxi',import_volume:'Import Hajmi',import_price:'Import Narxi'};
            let title = titles[metric] || 'Ma\'lumotlar';
            if (selectedCountryForView !== 'all') title = `${selectedCountryForView} - ${title}`;
            return title;
        }

        function getMetricLabel(metric) {
            return {export_volume:'Eksport Hajmi',export_price:'Eksport Narxi',import_volume:'Import Hajmi',import_price:'Import Narxi'}[metric] || 'Qiymat';
        }

        function formatChartNumber(value) {
            if (value >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
            else if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
            else if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
            return value.toFixed(0);
        }

        function updateChart() { updateChartWithCountryData(); }

        function exportChart() {
            if (!currentChart) { showToast('⚠️ Xatolik', 'Grafik mavjud emas', 'error'); return; }
            const url = currentChart.toBase64Image();
            const a = document.createElement('a');
            a.href = url;
            a.download = `imrs_chart_${new Date().toISOString().slice(0, 10)}.png`;
            a.click();
            showToast('✅ Yuklandi!', 'Grafik PNG formatida saqlandi', 'success');
        }

        // Metadata Functions (optimized)
        function updateMetadataWithCountryData() {
            if (!countryFilteredData.length) {
                ['totalRecords','uniqueCountries','uniqueProducts','yearRange','totalExport','totalImport'].forEach(id => document.getElementById(id).textContent = '0');
                document.getElementById('countryStats').innerHTML = '<p class="no-data">Ma\'lumot topilmadi</p>';
                return;
            }
            const totalRecords = countryFilteredData.length;
            const uniqueCountries = [...new Set(countryFilteredData.map(item => item.country || item.trading_partner))].length;
            const uniqueProducts = [...new Set(countryFilteredData.map(item => item.name || item.product_name))].length;
            const years = countryFilteredData.map(item => parseInt(item.year)).filter(year => !isNaN(year));
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            let totalExport = 0, totalImport = 0;
            if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) {
                totalExport = countryFilteredData.reduce((sum, item) => sum + (parseFloat(item.export_volume) || 0), 0);
            }
            if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) {
                totalImport = countryFilteredData.reduce((sum, item) => sum + (parseFloat(item.import_volume) || 0), 0);
            }
            document.getElementById('totalRecords').textContent = `${totalRecords.toLocaleString()} ta yozuv`;
            document.getElementById('uniqueCountries').textContent = `${uniqueCountries} ta davlat`;
            document.getElementById('uniqueProducts').textContent = `${uniqueProducts} ta mahsulot`;
            document.getElementById('yearRange').textContent = years.length ? `${minYear} - ${maxYear}` : '-';
            document.getElementById('totalExport').textContent = formatNumber(totalExport);
            document.getElementById('totalImport').textContent = formatNumber(totalImport);
            generateDetailedStats();
        }

        function generateDetailedStats() {
            const container = document.getElementById('countryStats');
            if (selectedCountryForView === 'all') {
                const stats = {};
                countryFilteredData.forEach(item => {
                    const country = item.country || item.trading_partner || 'Unknown';
                    if (!stats[country]) stats[country] = {records: 0, export: 0, import: 0};
                    stats[country].records++;
                    if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) {
                        stats[country].export += parseFloat(item.export_volume) || 0;
                    }
                    if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) {
                        stats[country].import += parseFloat(item.import_volume) || 0;
                    }
                });
                const sorted = Object.entries(stats).sort((a, b) => b[1].records - a[1].records).slice(0, 10);
                let html = '';
                sorted.forEach(([country, s]) => {
                    html += `<div class="stats-row"><span class="stats-country">${country}</span><span class="stats-value">${s.records} ta yozuv</span></div>`;
                });
                container.innerHTML = html;
            } else {
                const stats = {};
                countryFilteredData.forEach(item => {
                    const product = (item.name || item.product_name || 'Unknown').substring(0, 50);
                    if (!stats[product]) stats[product] = {records: 0, value: 0};
                    stats[product].records++;
                    if (selectedTradeDirections.includes('export') || selectedTradeDirections.length === 0) {
                        stats[product].value += parseFloat(item.export_volume) || 0;
                    } else if (selectedTradeDirections.includes('import')) {
                        stats[product].value += parseFloat(item.import_volume) || 0;
                    }
                });
                const sorted = Object.entries(stats).sort((a, b) => b[1].value - a[1].value).slice(0, 10);
                let html = '';
                sorted.forEach(([product, s]) => {
                    html += `<div class="stats-row"><span class="stats-country" title="${product}">${product.length > 30 ? product.substring(0, 27) + '...' : product}</span><span class="stats-value">${formatNumber(s.value)}</span></div>`;
                });
                container.innerHTML = html;
            }
        }

        // Export Functions (optimized)
        function showExportOptions() {
            const existing = document.getElementById('exportModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-secondary);border:2px solid var(--border-color);border-radius:16px;padding:30px;box-shadow:0 20px 60px var(--shadow-dark);z-index:1001;min-width:300px;text-align:center;';
            modal.innerHTML = `<h3 style="margin:0 0 20px 0;color:var(--text-primary);"><i class="fas fa-download"></i> Export qilish</h3><p style="margin:0 0 25px 0;color:var(--text-secondary);">Fayl formatini tanlang:</p><div style="display:flex;gap:15px;justify-content:center;"><button onclick="exportResults('csv');closeExportModal();" style="background:var(--accent-primary);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;"><i class="fas fa-file-csv"></i> CSV</button><button onclick="exportResults('excel');closeExportModal();" style="background:var(--success);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;"><i class="fas fa-file-excel"></i> Excel</button></div><button onclick="closeExportModal()" style="background:var(--text-muted);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:15px;">Bekor qilish</button>`;
            const backdrop = document.createElement('div');
            backdrop.id = 'exportBackdrop';
            backdrop.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;';
            backdrop.onclick = closeExportModal;
            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            const backdrop = document.getElementById('exportBackdrop');
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
        }

        function exportResults(format = 'csv') {
            showToast('📊 Export', `${format.toUpperCase()} fayl yuklanmoqda...`, 'info');
            try {
                const data = countryFilteredData.length > 0 ? countryFilteredData : currentData;
                if (!data || !data.length) { showToast('⚠️ Xatolik', 'Export uchun ma\'lumot yo\'q', 'error'); return; }
                if (format === 'csv') exportToCSV(data);
                else if (format === 'excel') exportToExcel(data);
                showToast('✅ Muvaffaqiyat!', `${format.toUpperCase()} fayl yuklandi`, 'success');
            } catch(e) {
                console.error('Export error:', e);
                showToast('❌ Xatolik', 'Export xatoligi', 'error');
            }
        }

        function exportToCSV(data) {
            const headers = getExportHeaders();
            const csvContent = [
                headers.join(','),
                ...data.map(item => [
                    `"${item.country || item.trading_partner || ''}"`,
                    `"${item.name || item.product_name || ''}"`,
                    `"${item.code || item.hs_code || item.hs_10_code || ''}"`,
                    `"${item.year || ''}"`,
                    getTradeDirectionText(item),
                    `"${item.measure || ''}"`,
                    ...(needsExportColumns() ? [item.export_volume || 0, item.export_price || 0] : []),
                    ...(needsImportColumns() ? [item.import_volume || 0, item.import_price || 0] : []),
                    `"${item.hs_group || ''}"`
                ].join(','))
            ].join('\n');
            const blob = new Blob(['\ufeff' + csvContent], {type: 'text/csv;charset=utf-8;'});
            downloadFile(blob, `imrs_data_${getCurrentDateString()}.csv`);
        }

        function exportToExcel(data) {
            if (typeof XLSX === 'undefined') { showToast('⚠️ Xatolik', 'Excel kutubxona yo\'q', 'error'); return; }
            const headers = getExportHeaders();
            const worksheetData = [
                headers,
                ...data.map(item => [
                    item.country || item.trading_partner || '',
                    item.name || item.product_name || '',
                    item.code || item.hs_code || item.hs_10_code || '',
                    item.year || '',
                    getTradeDirectionText(item),
                    item.measure || '',
                    ...(needsExportColumns() ? [item.export_volume || 0, item.export_price || 0] : []),
                    ...(needsImportColumns() ? [item.import_volume || 0, item.import_price || 0] : []),
                    item.hs_group || ''
                ])
            ];
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "IMRS Data");
            XLSX.writeFile(wb, `imrs_data_${getCurrentDateString()}.xlsx`);
        }

        function getExportHeaders() {
            let headers = ['Davlat','Mahsulot','HS Kod','Yil','Yo\'nalish','O\'lchov'];
            if (needsExportColumns()) headers.push('Eksport Hajmi', 'Eksport Narxi');
            if (needsImportColumns()) headers.push('Import Hajmi', 'Import Narxi');
            headers.push('HS Gruppa');
            return headers;
        }

        function getTradeDirectionText(item) {
            const directions = [];
            if ((selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) && (item.export_volume > 0 || item.export_price > 0)) {
                directions.push('Eksport');
            }
            if ((selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) && (item.import_volume > 0 || item.import_price > 0)) {
                directions.push('Import');
            }
            return `"${directions.join(' / ') || '-'}"`;
        }

        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function getCurrentDateString() {
            const now = new Date();
            return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        }

        // Helper Functions (optimized)
        function formatPrice(value) {
            if (value === null || value === undefined || value === '' || value === 0) return '0';
            if (typeof value === 'string' && !isNaN(value) && value.trim() !== '') value = parseFloat(value);
            if (typeof value === 'number' && !isNaN(value)) {
                return value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2});
            }
            return value;
        }

        function truncateText(text, length) {
            if (!text) return '-';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function formatNumber(num) {
            if (!num || num === 0) return '0';
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        function showToast(title, message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${title}</strong><br>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Initialize Everything (optimized)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 IMRS Optimized Loading...');
            initializeTheme();
            initializeLanguage();
            initializeCountrySearch();
            loadFilterData();
            
            // Header search Enter key
            const headerSearch = document.getElementById('headerSearch');
            if (headerSearch) {
                headerSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') performHeaderSearch();
                });
            }
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#seriesSearch') && !e.target.closest('#hsCodeSuggestions')) {
                    hideHSCodeSuggestions();
                }
            });
            
            console.log('✅ IMRS Optimized Ready!');
        });
    </script>
</body>
</html>